<polymer-element name="floating-menu-item" attributes="label action arguments expanded options">
  <template>
    <link href="floating-menu-item.css" rel="stylesheet" type="text/css" />
    <floating-submenu id="submenu" options="{{options}}" expanded="{{expanded}}"><content></content></floating-submenu>
    &nbsp;{{label}}&nbsp;
  </template>
  <script>
  (function() {

    var MARGIN = 8;

    function invokeFunction(obj, path, args) {
      var idx = path.indexOf('.');
      if (idx < 0) {
        obj[path].apply(obj, args);
        return;
      }
      var first = path.substring(0,idx);
      var rest = path.substring(idx+1);
      invokeFunction(obj[first], rest, args);
    }

    Polymer('floating-menu-item', {
      label: '',
      action: undefined,
      arguments: undefined,
      expanded: false,
      options: [],
      ready: function() {
        var scope = this;

        this.hover = function(event) {
          // event.preventDefault();
          // event.stopPropagation();
          scope.pointerEvent = event;
          scope.fire('floating-item-hovered', scope);
        };
        this.fireAction = function(event) {
          event.preventDefault();
          event.stopPropagation();
          var args = scope.arguments;
          var action = scope.action;

          if (typeof args == 'string') args = args.split(' ');
          if (!args instanceof Array) args = [args];

          if (typeof action == 'function') action.apply(null, args);
          if (typeof action == 'string') action = invokeFunction(window, action, args);

          this.fire('floating-menu-action-fired', this);
        };
        this.nudgeLeft = function(event) {
          event.stopPropagation();
          var rect = scope.getBoundingClientRect();
          var submenuRect = scope.$.submenu.getBoundingClientRect();
          var rightDist = (rect.right+submenuRect.width+MARGIN) - window.innerWidth; 
          if (rightDist > 0) {
            scope.$.submenu.style.left = - submenuRect.width + 'px';
          } else {
            scope.$.submenu.style.left = '100%';
          }
          Platform.flush();
        };
      },
      attached: function() {
        var scope = this;
        setTimeout(function(){
          scope.fire('floating-menu-item-attached', scope);
        }, 1);
      },
      detached: function() {
        this.fire('floating-menu-item-detached', this);
      },
      actionChanged: function() {
        this.checkIfActive();
      },
      optionsChanged: function() {
        this.checkIfActive();
      },
      checkIfActive: function() {
        this.classList.toggle('active', this.action || this.options.length || this.$.submenu.items.length);
      },
      listenChanged: function() {
        // TODO: test
        if (this.listen) {
          if (this.action || this.$.submenu.items.length === 0) {
            this.addEventListener('click', this.fireAction);
            this.addEventListener('touchend', this.fireAction);
          }

          this.addEventListener('floating-submenu-expanded', this.nudgeLeft);

          this.addEventListener('mouseover', this.hover);
          this.addEventListener('touchstart', this.hover);
          this.addEventListener('pointermove', this.hover);
        } else {
          this.removeEventListener('click', this.fireAction);
          this.removeEventListener('touchend', this.fireAction);

          this.addEventListener('floating-submenu-expanded', this.nudgeLeft);

          this.removeEventListener('mouseover', this.hover);
          this.removeEventListener('touchstart', this.hover);
          this.removeEventListener('pointermove', this.hover);
        }
      },
      expandedChanged: function() {
        this.classList.toggle('expanded', this.expanded);

        if (this.expanded) {
          this.fire('floating-item-expanded', this);
        } else {
          this.fire('floating-item-collapsed', this);
        }

        Platform.flush();
      }
    });

  })();
  </script>
</polymer-element>