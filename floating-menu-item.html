<polymer-element name="floating-menu-item" attributes="root label listen empty action arguments expanded options">
  <template>
    <link href="floating-menu-item.css" rel="stylesheet" type="text/css" />
    <floating-submenu id="submenu" root="{{root}}"options="{{options}}" expanded="{{expanded}}"><content></content></floating-submenu>
    &nbsp;{{label}}&nbsp;
  </template>
  <script>
  (function() {

    function invokeFunction(obj, path, args) {
      var idx = path.indexOf('.');
      if (idx < 0) {
        obj[path].apply(obj, args);
        return;
      }
      var first = path.substring(0,idx);
      var rest = path.substring(idx+1);
      invokeFunction(obj[first], rest, args);
    }

    Polymer('floating-menu-item', {
      label: '',
      action: undefined,
      arguments: undefined,
      expanded: false,
      options: [],
      holdTime: 250,
      ready: function() {
        var scope = this;

        this.fireAction = function(event) {
          event.preventDefault();
          event.stopPropagation();
          var args = scope.arguments;
          var action = scope.action;

          if (typeof args == 'string') args = args.split(' ');
          if (!args instanceof Array) args = [args];

          if (typeof action == 'function') action.apply(null, args);
          if (typeof action == 'string') action = invokeFunction(window, action, args);

          this.fire('floating-menu-action-fired', this);
        };
      },
      attached: function() {
        var scope = this;
        setTimeout(function(){ // chromium bug?
          scope.fire('floating-menu-item-attached', scope);
        },1);
      },
      detached: function() {
        var scope = this;
        setTimeout(function(){ // chromium bug?
          this.fire('floating-menu-item-detached', this);
        },1);
      },
      update: function() {
        var scope = this;
        this.classList.toggle('active', this.action || this.options.length || this.$.submenu.items.length);
        setTimeout(function(){
          scope.rect = scope.getBoundingClientRect();
          scope.$.submenu.parentHeight = scope.rect.height;
          scope.$.submenu.parentWidth = scope.rect.width;
        },1);
      },
      listenChanged: function() {
        this.update();
        if (this.listen) {
          if (this.action || this.$.submenu.items.length === 0) {
            this.addEventListener('click', this.fireAction);
            this.addEventListener('touchend', this.fireAction);
          }
        } else {
          this.removeEventListener('click', this.fireAction);
          this.removeEventListener('touchend', this.fireAction);
        }
      },
      expandedChanged: function() {
        this.classList.toggle('expanded', this.expanded);
        if (this.expanded) {
          this.fire('floating-item-expanded', this);
        } else {
          this.fire('floating-item-collapsed', this);
        }
      }
    });

  })();
  </script>
</polymer-element>