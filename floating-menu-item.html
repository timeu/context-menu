<polymer-element name="floating-menu-item" attributes="label action arguments expanded options">
  <template>
    <link href="floating-menu-item.css" rel="stylesheet" type="text/css" />
    <floating-submenu id="submenu" options="{{options}}" expanded="{{expanded}}"><content></content></floating-submenu>
    &nbsp;{{label}}&nbsp;
  </template>
  <script>
  (function() {

    var MARGIN = 8;

    function invokeFunction(obj, path, args) {
      var idx = path.indexOf('.');
      if (idx < 0) {
        obj[path].apply(obj, args);
        return;
      }
      var first = path.substring(0,idx);
      var rest = path.substring(idx+1);
      invokeFunction(obj[first], rest, args);
    }

    Polymer('floating-menu-item', {
      label: '',
      action: undefined,
      arguments: undefined,
      expanded: false,
      options: [],
      attached: function() {
        var scope = this;

        this.addEventListener('pointerover', function(event) {  
          event.stopPropagation();  
          scope.pointerEvent = event;
          scope.fire('floating-item-hovered', scope);
        });



        var onClick = function(event) {
          event.stopPropagation();
          
          var args = scope.arguments;
          var action = scope.action;

          if (typeof args == 'string') args = args.split(' ');
          if (!args instanceof Array) args = [args];

          if (typeof action == 'function') action.apply(null, args);
          if (typeof action == 'string') action = invokeFunction(window, action, args);

          if (scope.action || scope.$.submenu.items.length === 0) scope.fire('floating-menu-item-clicked', scope);
        };
        
        this.addEventListener('click', onClick);
        
        // this.addEventListener('pointerup', function(event) {
        //   if (event.pointerType == "mouse") onClick(event);
        // });

        // right clipping
        this.addEventListener('floating-submenu-expanded', function(event){
          event.stopPropagation();
          var rect = scope.getBoundingClientRect();
          var submenuRect = scope.$.submenu.getBoundingClientRect();
          var rightDist = (rect.right+submenuRect.width+MARGIN) - window.innerWidth; 
          if (rightDist > 0) {
            scope.$.submenu.style.left = - submenuRect.width + 'px';
          } else {
            scope.$.submenu.style.left = '100%';
          }
          Platform.flush();
        });

        setTimeout(function(){
          scope.fire('floating-menu-item-attached', scope);
        }, 1);
      },
      detached: function() {
        this.fire('floating-menu-item-detached', this);
      },
      actionChanged: function() {
        this.checkIfActive();
      },
      optionsChanged: function() {
        this.checkIfActive();
      },
      checkIfActive: function() {
        this.classList.toggle('active', this.action || this.options.length || this.$.submenu.items.length);
      },
      expandedChanged: function() {
        var scope = this;
        this.classList.toggle('expanded', this.expanded);
        if (this.expanded) this.fire('floating-item-expanded', this);
        Platform.flush();
      }
    });

  })();
  </script>
</polymer-element>