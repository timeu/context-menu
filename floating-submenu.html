<polymer-element name="floating-submenu" attributes="expanded options htmlOptions">
  <template>
    <link href="floating-submenu.css" rel="stylesheet" type="text/css" />
    <template repeat="{{options}}">
      <floating-menu-item id="item" label="{{label}}" action="{{action}}" arguments="{{arguments}}" options="{{options}}">
      </floating-menu-item>
    </template>
    <content></content>
  </template>
  <script>
  (function() {

    var HOLD_TIME = 250;
    var MARGIN = 8;
    
    Polymer('floating-submenu', {
      top: 0,
      left: 0,
      expanded: false,
      ready: function() {

        var scope = this;

        var x = 0, y = 0, d = 0, tempD;
        var expandTimeout = {};

        this.expandItem = function(item) {
          item.expanded = true;
          expandTimeout.cleared = true;
        };
        this.updatePointerVelocity = function(event) {
          event.preventDefault();
          tempD = Math.abs(event.clientY - y)/2 - (event.clientX - x);
          d = tempD;//(d*2 + tempD) / 3;
          x = event.clientX;
          y = event.clientY;
        };
        this.nudgeUp = function() {
          var rect = this.getBoundingClientRect();
          var bottomDist = (rect.bottom-this.top+MARGIN) - window.innerHeight;
          if (bottomDist > 0) this.top = - bottomDist;
          else this.top = 0;
        };
        this.iterateItems = function( callback ) {
          for (var i = this.items.length; i--;) callback(this.items[i]);
          this.classList.toggle('empty', this.items.length === 0);
        };
        this.resetItems = function() {
          this.iterateItems(function(item){
            item.expanded = false;
            item.checkIfActive();
            item.listen = scope.expanded;
          });
        };

        //TODO detach
        scope.items = [];
        this.addEventListener('floating-menu-item-attached', function(event){
          event.stopPropagation();
          scope.items.push(event.detail);
        });

        this.addEventListener('floating-item-expanded', function(event){
          event.stopPropagation();
          // unexpand all except the one just expanded
          scope.iterateItems(function(item){
            if (item != event.detail) {
              item.expanded = false;
            }
          });
        });

        this.addEventListener('floating-item-hovered', function(event){
          clearTimeout(expandTimeout);
          var noneSelected = true;
          scope.iterateItems(function(item){
            if (item != event.detail && item.expanded) {
              noneSelected = false;
            }
          });
          if (d > 0 || noneSelected) {
            this.expandItem(event.detail);        
          } else {
            expandTimeout.cleared = false;
            expandTimeout = setTimeout(function(){scope.expandItem(event.detail);}, HOLD_TIME);
          }
        });

      },
      expandedChanged: function() {
        this.classList.toggle('expanded', this.expanded);

        this.resetItems();

        if (this.expanded) {
          this.nudgeUp();

          this.addEventListener('mousemove', this.updatePointerVelocity);
          this.addEventListener('touchmove', this.updatePointerVelocity);

          this.fire('floating-submenu-expanded', this);
        } else {
          this.removeEventListener('mousemove', this.updatePointerVelocity);
          this.removeEventListener('touchmove', this.updatePointerVelocity);

          this.fire('floating-submenu-collapsed', this);
        }
        Platform.flush();
      },
      topChanged: function() {
        this.style.top = this.top + 'px';
      }
    });
  })();
  </script>
</polymer-element>