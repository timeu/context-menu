<polymer-element name="floating-submenu" attributes="root expanded options direction">
  <template>
    <link href="floating-submenu.css" rel="stylesheet" type="text/css" />
    <template repeat="{{option in options}}">
      <floating-menu-item id="item" root="{{root}}" label="{{option.label}}" action="{{option.action}}" arguments="{{option.arguments}}" options="{{option.options}}">
      </floating-menu-item>
    </template>
    <content></content>
  </template>
  <script>
  (function() {

    var MARGIN = 8;
    
    Polymer('floating-submenu', {
      top: 0,
      left: 0,
      parentWidth: 0,
      parentHeight: 0,
      expanded: false,
      direction: 'right',
      ready: function() {
        var scope = this;

        this.nudge = function() {
          // Todo: watch for scroll
          if (this.direction == 'right') {
            // nudge up
            var bottomDist = (this.rect.bottom + MARGIN) - window.innerHeight;
            if (bottomDist > 0) this.top = - bottomDist;
            // nudge left
            var rightDist = (this.rect.right - this.left) - window.innerWidth;
            if (rightDist > 0 && this.parentWidth === 0) this.left = - rightDist;
            else if (rightDist > - this.parentWidth) this.left = - this.rect.width;
            else this.left = this.parentWidth;
          } else if (this.direction == 'down') {
            this.top = this.parentHeight;
          }
          
        };

        this.resetItems = function() {
          for (var i = this.items.length; i--;){
            this.items[i].expanded = false;
            this.items[i].update();
          }
        };

        this.addEventListener('floating-submenu-expanded', function(event){
          scope.rect = scope.getBoundingClientRect();
          if (scope == event.detail) {
            event.detail.nudge();
            return;
          }
          event.stopPropagation();
          event.detail.nudge();
          this.rect = this.getBoundingClientRect();
        });

        scope.items = [];
        this.addEventListener('floating-menu-item-attached', function(event){
          event.stopPropagation();
          scope.items.push(event.detail);
          event.detail.bind('root', new PathObserver(scope, 'root'));
          event.detail.bind('listen', new PathObserver(scope, 'expanded'));
        });

        this.addEventListener('floating-item-expanded', function(event){
          event.stopPropagation();
          // unexpand all except the one just expanded
          for (var i = this.items.length; i--;){
            if (this.items[i] != event.detail) {
              this.items[i].expanded = false;
            }
          }
        });

      },
      expandedChanged: function() {
        this.classList.toggle('expanded', this.expanded);
        this.classList.toggle('empty', this.items.length === 0);

        this.resetItems();
        if (this.expanded) {
          this.fire('floating-submenu-expanded', this);
        } else {
          this.fire('floating-submenu-collapsed', this);
          this.top = 0;
        }
      },
      topChanged: function() {
        this.style.top = this.top + 'px';
      },
      leftChanged: function() {
        this.style.left = this.left + 'px';
      }
    });
  })();
  </script>
</polymer-element>