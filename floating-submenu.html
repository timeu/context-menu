<polymer-element name="floating-submenu" attributes="expanded options htmlOptions">
  <template>
    <link href="floating-submenu.css" rel="stylesheet" type="text/css" />
    <template repeat="{{options}}">
      <floating-menu-item id="item" label="{{label}}" action="{{action}}" param="{{param}}" options="{{options}}">
      </floating-menu-item>
    </template>
    <content></content>
  </template>
  <script>
  (function() {

    var HOLD_TIME = 250;
    var MARGIN = 8;
    
    Polymer('floating-submenu', {
      top: 0,
      left: 0,
      expanded: false,
      items: [],
      htmlItems: [], 
      ready: function() {

        var scope = this;
        
        this.setAttribute('touch-action', 'none');
        this.setAttribute('oncontextmenu', 'return false');

        this.addEventListener('floating-item-expanded', function(event){
          event.stopPropagation();
          // unexpand all except the one just expanded
          scope.itterateItems(function(item){
            if (item != event.detail) {
              item.expanded = false;
            }
          });
        });

        var x = 0, y = 0, d = 0, tempD;
        var expandTimeout = {};

        this.addEventListener('pointermove', function(event){
          tempD = Math.abs(event.clientY - y)/2 - (event.clientX - x);
          d = (d*2 + tempD) / 3;
          x = event.clientX;
          y = event.clientY;
        });

        this.addEventListener('floating-item-hovered', function(event){
          clearTimeout(expandTimeout);
          var noneSelected = true;
          scope.itterateItems(function(item){
            if (item != event.detail && item.expanded) {
              noneSelected = false;
            }
          });

          if (d > 0 || event.detail.pointerEvent.pointerType != "mouse" || noneSelected) {
            expandSubmenu(event.detail);        
          } else {
            expandTimeout.cleared = false;
            expandTimeout = setTimeout(function(){expandSubmenu(event.detail);}, HOLD_TIME);
          }
        });

        var expandSubmenu = function(node) {
          node.expanded = true;
          expandTimeout.cleared = true;
        };

      },
      itterateItems: function( callback ) {
        this.items = this.shadowRoot.querySelectorAll('floating-menu-item');
        for (var i = 0; i < this.items.length; i++ ){
          callback(this.items[i]);
        }
        // this.htmlItems needs to be set externally
        for (i = 0; i < this.htmlItems.length; i++ ){
          callback(this.htmlItems[i]);
        }
        this.classList.toggle('empty', this.items.length === 0 && this.htmlItems.length === 0);
      },   
      expandedChanged: function() {
        this.classList.toggle('expanded', this.expanded);
        // unexpand all
        this.itterateItems(function(item){
          item.expanded = false;
        });

        if (this.expanded) {
          // bottom clipping
          var rect = this.getBoundingClientRect();
          var bottomDist = (rect.bottom-this.top+MARGIN) - window.innerHeight;
          if (bottomDist > 0) this.top = - bottomDist;
          else this.top = 0;
          this.fire('floating-submenu-expanded', this);
        }
      },
      topChanged: function() {
        this.style.top = this.top + 'px';
      }
    });
  })();
  </script>
</polymer-element>