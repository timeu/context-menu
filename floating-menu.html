<link rel="import" href="floating-menu-veil.html">
<link rel="import" href="floating-submenu.html">
<link rel="import" href="floating-menu-item.html">

<polymer-element name="floating-menu" attributes="parent options">
  <template>
    <link href="floating-menu.css" rel="stylesheet" type="text/css" />
    <floating-submenu id="submenu" expanded="{{expanded}}" options="{{options}}">
      <content></content>
    </floating-submenu>
  </template>
  <script>
  (function() {

    var HOLD_TIME = 250;
    var MARGIN = 8;

    Polymer('floating-menu', {
      expanded: false,
      ready: function() {

        var scope = this;

        var timeout;
        
        this.veil = document.querySelector('#floating-menu-veil');

        // menu-closing events
        this.veil.addEventListener('pointerover', function(event){
          timeout = setTimeout(function(){
            scope.expanded = false;
          }, HOLD_TIME);
        });
        this.veil.addEventListener('pointerdown', function(event){
          scope.expanded = false;
        });
        window.addEventListener('scroll', function(event){
          scope.expanded = false;
        });
        this.addEventListener('floating-menu-item-clicked', function(event){
          scope.expanded = false;
        });

        this.addEventListener('pointermove', function(event){
          clearTimeout(timeout);
        });

        // right clipping
        this.addEventListener('floating-submenu-expanded', function(event){
          event.stopPropagation();
          var rect = scope.getBoundingClientRect();
          var submenuRect = scope.$.submenu.getBoundingClientRect();
          var rightDist = (submenuRect.right+MARGIN) - window.innerWidth; 
          if (rightDist > 0) scope.style.left = rect.left - rightDist + 'px';
        });

        this.expand = function(event) {
          event.preventDefault();
          scope.expanded = true;
          scope.style.top = event.clientY - 8 + "px";
          scope.style.left = event.clientX - 8 + "px";
          clearTimeout(timeout);
        };

        document.addEventListener('contextmenu', this.expand);
      },
      parentChanged: function() {
        document.removeEventListener('contextmenu', this.expand);
        this.parent.addEventListener('contextmenu', this.expand);
      },
      expandedChanged: function() {
        this.classList.toggle('expanded', this.expanded);
        if (this.expanded === true) {
          this.fire('floating-menu-expanded', this);
        } else {
          this.fire('floating-menu-collapsed', this);
        }
        Platform.flush();
      }
    });

  })();
  </script>
</polymer-element>