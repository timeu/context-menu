<polymer-element name="floating-menu-veil" assetpath="../">
  <template>
    <style type="text/css">:host {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
  z-index: 999999;
  cursor: default;
  /*background: black;*/
  /*opacity: 0.25;*/
}
:host(.visible) {
  display: block;
}</style>
  </template>
  <script>
  (function(){
    var veil = document.createElement('floating-menu-veil');
    veil.id = 'floating-menu-veil';
    document.body.appendChild(veil);
    Polymer('floating-menu-veil', {
      ready: function() {
        var scope = this;
        this.setAttribute( 'oncontextmenu', 'return false');
        window.addEventListener('floating-menu-expanded', function(){
          scope.classList.toggle('visible', true);
        });
        window.addEventListener('floating-menu-collapsed', function(){
          scope.classList.toggle('visible', false);
        });
      }
    });
  })();
  </script>
</polymer-element>
<polymer-element name="floating-submenu" attributes="expanded options htmlOptions" assetpath="../">
  <template>
    <style type="text/css">:host {
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  -ms-box-sizing: border-box;
  -webkit-transform: translate3d(0,0,0);
  -moz-transform: translate3d(0,0,0);
  -ms-transform: translate3d(0,0,0);
  -o-transform: translate3d(0,0,0);
  transform: translate3d(0,0,0);
  display: none;
  position: absolute;
  z-index: 1000001;
  top:0;
  left: 100%;
  min-width: 80px;
  border: 1px solid rgba(255, 255, 255, 0.25);
  padding: 4px 0;
  border-radius: 2px;
  background: #666;
  box-shadow: -2px 2px 10px rgba(0, 0, 0, 0.5);
}

:host(.expanded:not(.empty)) {
  display: block;
}</style>
    <template repeat="{{options}}">
      <floating-menu-item id="item" label="{{label}}" action="{{action}}" arguments="{{arguments}}" options="{{options}}">
      </floating-menu-item>
    </template>
    <content></content>
  </template>
  <script>
  (function() {

    var HOLD_TIME = 250;
    var MARGIN = 8;
    
    Polymer('floating-submenu', {
      top: 0,
      left: 0,
      expanded: false,
      ready: function() {

        var scope = this;

        var x = 0, y = 0, d = 0, tempD;
        var expandTimeout = {};

        this.expandItem = function(item) {
          item.expanded = true;
          expandTimeout.cleared = true;
        };
        this.updatePointerVelocity = function(event) {
          event.preventDefault();
          tempD = Math.abs(event.clientY - y)/2 - (event.clientX - x);
          d = tempD;//(d*2 + tempD) / 3;
          x = event.clientX;
          y = event.clientY;
        };
        this.nudgeUp = function() {
          var rect = this.getBoundingClientRect();
          var bottomDist = (rect.bottom-this.top+MARGIN) - window.innerHeight;
          if (bottomDist > 0) this.top = - bottomDist;
          else this.top = 0;
        };
        this.iterateItems = function( callback ) {
          for (var i = this.items.length; i--;) callback(this.items[i]);
          this.classList.toggle('empty', this.items.length === 0);
        };
        this.resetItems = function() {
          this.iterateItems(function(item){
            item.expanded = false;
            item.checkIfActive();
            item.listen = scope.expanded;
          });
        };

        //TODO detach
        scope.items = [];
        this.addEventListener('floating-menu-item-attached', function(event){
          event.stopPropagation();
          scope.items.push(event.detail);
        });

        this.addEventListener('floating-item-expanded', function(event){
          event.stopPropagation();
          // unexpand all except the one just expanded
          scope.iterateItems(function(item){
            if (item != event.detail) {
              item.expanded = false;
            }
          });
        });

        this.addEventListener('floating-item-hovered', function(event){
          clearTimeout(expandTimeout);
          var noneSelected = true;
          scope.iterateItems(function(item){
            if (item != event.detail && item.expanded) {
              noneSelected = false;
            }
          });
          if (d > 0 || noneSelected) {
            this.expandItem(event.detail);        
          } else {
            expandTimeout.cleared = false;
            expandTimeout = setTimeout(function(){scope.expandItem(event.detail);}, HOLD_TIME);
          }
        });

      },
      expandedChanged: function() {
        this.classList.toggle('expanded', this.expanded);

        this.resetItems();

        if (this.expanded) {
          this.nudgeUp();

          this.addEventListener('mousemove', this.updatePointerVelocity);
          this.addEventListener('touchmove', this.updatePointerVelocity);

          this.fire('floating-submenu-expanded', this);
        } else {
          this.removeEventListener('mousemove', this.updatePointerVelocity);
          this.removeEventListener('touchmove', this.updatePointerVelocity);

          this.fire('floating-submenu-collapsed', this);
        }
        Platform.flush();
      },
      topChanged: function() {
        this.style.top = this.top + 'px';
      }
    });
  })();
  </script>
</polymer-element>
<polymer-element name="floating-menu-item" attributes="label action arguments expanded options" assetpath="../">
  <template>
    <style type="text/css">:host {
  position: relative;
  display: block;
  cursor: pointer;
  min-width: 80px;
  padding: 2px 9px;
  border-radius: 1px;
  color: #ccc;
}
:host(:not(.active)) {
  opacity: 0.25;
}
:host(.expanded) {
  background: #69F;
  color: #fff;
}</style>
    <floating-submenu id="submenu" options="{{options}}" expanded="{{expanded}}"><content></content></floating-submenu>
    &nbsp;{{label}}&nbsp;
  </template>
  <script>
  (function() {

    var MARGIN = 8;

    function invokeFunction(obj, path, args) {
      var idx = path.indexOf('.');
      if (idx < 0) {
        obj[path].apply(obj, args);
        return;
      }
      var first = path.substring(0,idx);
      var rest = path.substring(idx+1);
      invokeFunction(obj[first], rest, args);
    }

    Polymer('floating-menu-item', {
      label: '',
      action: undefined,
      arguments: undefined,
      expanded: false,
      options: [],
      ready: function() {
        var scope = this;

        this.hover = function(event) {
          // event.preventDefault();
          // event.stopPropagation();
          scope.pointerEvent = event;
          scope.fire('floating-item-hovered', scope);
        };
        this.fireAction = function(event) {
          event.preventDefault();
          event.stopPropagation();
          var args = scope.arguments;
          var action = scope.action;

          if (typeof args == 'string') args = args.split(' ');
          if (!args instanceof Array) args = [args];

          if (typeof action == 'function') action.apply(null, args);
          if (typeof action == 'string') action = invokeFunction(window, action, args);

          this.fire('floating-menu-action-fired', this);
        };
        this.nudgeLeft = function(event) {
          event.stopPropagation();
          var rect = scope.getBoundingClientRect();
          var submenuRect = scope.$.submenu.getBoundingClientRect();
          var rightDist = (rect.right+submenuRect.width+MARGIN) - window.innerWidth; 
          if (rightDist > 0) {
            scope.$.submenu.style.left = - submenuRect.width + 'px';
          } else {
            scope.$.submenu.style.left = '100%';
          }
          Platform.flush();
        };
      },
      attached: function() {
        var scope = this;
        setTimeout(function(){
          scope.fire('floating-menu-item-attached', scope);
        }, 1);
      },
      detached: function() {
        this.fire('floating-menu-item-detached', this);
      },
      actionChanged: function() {
        this.checkIfActive();
      },
      optionsChanged: function() {
        this.checkIfActive();
      },
      checkIfActive: function() {
        this.classList.toggle('active', this.action || this.options.length || this.$.submenu.items.length);
      },
      listenChanged: function() {
        // TODO: test
        if (this.listen) {
          if (this.action || this.$.submenu.items.length === 0) {
            this.addEventListener('click', this.fireAction);
            this.addEventListener('touchend', this.fireAction);
          }

          this.addEventListener('floating-submenu-expanded', this.nudgeLeft);

          this.addEventListener('mouseover', this.hover);
          this.addEventListener('touchstart', this.hover);
          this.addEventListener('pointermove', this.hover);
        } else {
          this.removeEventListener('click', this.fireAction);
          this.removeEventListener('touchend', this.fireAction);

          this.addEventListener('floating-submenu-expanded', this.nudgeLeft);

          this.removeEventListener('mouseover', this.hover);
          this.removeEventListener('touchstart', this.hover);
          this.removeEventListener('pointermove', this.hover);
        }
      },
      expandedChanged: function() {
        this.classList.toggle('expanded', this.expanded);

        if (this.expanded) {
          this.fire('floating-item-expanded', this);
        } else {
          this.fire('floating-item-collapsed', this);
        }

        Platform.flush();
      }
    });

  })();
  </script>
</polymer-element>

<polymer-element name="floating-menu" attributes="parent options" assetpath="../">
  <template>
    <style type="text/css">:host {
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  white-space:nowrap;
  font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
  font-size: 13px;
  color: white;
  visibility: hidden;
  position: fixed;
  z-index: 1000000;
  background: red;
  cursor: default;
}
:host(.expanded) {
  visibility: visible;
}</style>
    <floating-submenu id="submenu" expanded="{{expanded}}" options="{{options}}">
      <content></content>
    </floating-submenu>
  </template>
  <script>
  (function() {

    var HOLD_TIME = 250;
    var MARGIN = 8;
    var timeout;

    Polymer('floating-menu', {
      expanded: false,
      ready: function() {
        var scope = this;

        this.collapse = function() {
          event.preventDefault();
          event.stopPropagation();
          scope.expanded = false;
        };
        this.collapseLater = function() {
          event.preventDefault();
          event.stopPropagation();
          timeout = setTimeout(function(){
            scope.expanded = false;
          }, HOLD_TIME);
        };
        this.cancelCollapse = function () {
          event.preventDefault();
          event.stopPropagation();
          clearTimeout(timeout);
        };
        this.expand = function(event) {
          event.preventDefault();
          event.stopPropagation();
          scope.expanded = true;
          scope.style.top = event.clientY - 8 + "px";
          scope.style.left = event.clientX - 8 + "px";
          clearTimeout(timeout);
        };
        this.nudgeLeft = function(event) {
          event.stopPropagation();
          var rect = scope.getBoundingClientRect();
          var submenuRect = scope.$.submenu.getBoundingClientRect();
          var rightDist = (submenuRect.right+MARGIN) - window.innerWidth; 
          if (rightDist > 0) scope.style.left = rect.left - rightDist + 'px';
        };

        this.veil = document.querySelector('#floating-menu-veil');        

        document.addEventListener('contextmenu', this.expand);
      },
      parentChanged: function() {
        document.removeEventListener('contextmenu', this.expand);
        this.parent.addEventListener('contextmenu', this.expand);
      },
      expandedChanged: function() {
        this.classList.toggle('expanded', this.expanded);

        if (this.expanded) {
          this.veil.addEventListener('mouseover', this.collapseLater);
          this.veil.addEventListener('mousedown', this.collapse);
          this.veil.addEventListener('touchstart', this.collapse);
          window.addEventListener('scroll', this.collapse);
          this.addEventListener('floating-menu-action-fired', this.collapse);
          this.addEventListener('pointermove', this.cancelCollapse);
          this.addEventListener('floating-submenu-expanded', this.nudgeLeft);

          this.fire('floating-menu-expanded', this);
        } else {
          this.veil.removeEventListener('mouseover', this.collapseLater);
          this.veil.removeEventListener('mousedown', this.collapse);
          this.veil.removeEventListener('touchstart', this.collapse);
          window.removeEventListener('scroll', this.collapse);
          this.removeEventListener('floating-menu-action-fired', this.collapse);
          this.removeEventListener('pointermove', this.cancelCollapse);
          this.removeEventListener('floating-submenu-expanded', this.nudgeLeft);
        
          this.fire('floating-menu-collapsed', this);
        }

        Platform.flush();
      }
    });

  })();
  </script>
</polymer-element>